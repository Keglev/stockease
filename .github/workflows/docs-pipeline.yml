name: Docs Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - './src/main/**'
      - './docs/**'
      - './pom.xml'
      - './.github/workflows/docs-pipeline.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build & generate OpenAPI (verify)
        working-directory: backend
        run: |
          ./mvnw -B -ntp -DskipTests verify
          test -f target/docs/openapi.json || (echo "âŒ openapi.json missing" && exit 1)

      - name: Generate ReDoc HTML
        run: |
          npm install -g redoc-cli
          cd backend/target/docs
          redoc-cli build openapi.json -o index.html

      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Convert Markdown to HTML (preserve structure)
        run: |
          src="backend/docs"
          out="backend/target/docs/generated"
          mkdir -p "$out"
          find "$src" -type f -name "*.md" | while read md; do
            rel="${md#$src/}"
            out_file="$out/${rel%.md}.html"
            mkdir -p "$(dirname "$out_file")"
            pandoc "$md" -f markdown -t html --toc -s -o "$out_file"
          done

      - name: Generate sitemap
        run: |
          mkdir -p backend/target/docs
          cat > backend/target/docs/sitemap.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://keglev.github.io/stockease/</loc>
              <priority>1.0</priority>
            </url>
            <url>
              <loc>https://keglev.github.io/stockease/generated/</loc>
              <priority>0.8</priority>
            </url>
          </urlset>
          EOF

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: backend/target/docs
          # cname: stockease.example.com  # optional
