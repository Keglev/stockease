################################################################################
#
# STOCKEASE DOCUMENTATION PIPELINE
# ================================
#
# Workflow: GitHub Actions - Automated Documentation Generation & Deployment
#
# PURPOSE:
#   Generates professional enterprise documentation from architecture markdown
#   files and OpenAPI specifications. Triggered automatically on push to /docs
#   directory. Publishes to GitHub Pages with mermaid diagram rendering.
#
# TRIGGER EVENTS:
#   - Push to main branch when /docs/** or .github/workflows/docs-pipeline.yml changes
#   - Manual trigger: workflow_dispatch (via GitHub Actions UI)
#
# BUILD PIPELINE:
#   1. Setup: Install Node.js, Pandoc, ReDoc CLI
#   2. API Docs: Generate OpenAPI docs from openapi.yaml
#   3. Architecture: Convert markdown ‚Üí HTML with Pandoc + Lua filters
#   4. Additional Docs: Process other markdown files
#   5. Links: Fix relative links and directory references
#   6. Index: Create navigation index
#   7. Deploy: Publish to GitHub Pages (gh-pages branch)
#
# KEY TECHNOLOGIES:
#   - Pandoc: Markdown ‚Üí HTML conversion with custom templates
#   - Lua Filters: Post-process Pandoc output (mermaid rendering)
#   - ReDoc: OpenAPI specification documentation
#   - GitHub Pages: Static site hosting
#   - Mermaid.js: Architecture diagram rendering
#
# OUTPUT STRUCTURE:
#   target/docs/
#   ‚îú‚îÄ‚îÄ index.html (landing page)
#   ‚îú‚îÄ‚îÄ api-docs.html (OpenAPI reference)
#   ‚îú‚îÄ‚îÄ templates/ (CSS, HTML templates)
#   ‚îî‚îÄ‚îÄ architecture/
#       ‚îú‚îÄ‚îÄ *.html (architecture pages)
#       ‚îú‚îÄ‚îÄ testing/
#       ‚îú‚îÄ‚îÄ deployment/
#       ‚îú‚îÄ‚îÄ patterns/
#       ‚îú‚îÄ‚îÄ components/
#       ‚îî‚îÄ‚îÄ decisions/
#
# DEPLOYMENT:
#   Published to: https://keglev.github.io/stockease/
#   Branch: gh-pages (managed by actions-gh-pages)
#
# DOCUMENTATION:
#   - Each markdown file becomes a styled HTML page
#   - Mermaid diagrams render via Lua filter + mermaid.js
#   - Sidebar navigation auto-generated from menu structure
#   - Table of contents auto-generated from headings
#
# MAINTENANCE:
#   - Update docs/** markdown ‚Üí auto-deployed
#   - Modify template ‚Üí regenerate all docs
#   - Add/remove API specs ‚Üí updates automatically
#   - Mermaid syntax errors logged in workflow output
#
# LAST UPDATED: 2025-11-04
# VERSION: 3.0 (CSS extraction + mermaid rendering fix)
#
################################################################################

name: Docs Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '.github/workflows/docs-pipeline.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Detect project root (root vs /backend)
        id: where
        run: |
          if [ -f "docs/api/openapi.yaml" ] && [ -f "pom.xml" ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          elif [ -f "backend/docs/api/openapi.yaml" ] && [ -f "backend/pom.xml" ]; then
            echo "dir=backend" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No OpenAPI YAML found in docs/api/ or backend/docs/api/" >&2
            exit 1
          fi
          echo "Using dir=$(cat $GITHUB_OUTPUT | cut -d= -f2)"

      - name: Install Node.js and ReDoc CLI
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate documentation from modular OpenAPI YAML
        run: |
          npm install -g @redocly/cli
          PROJECT_DIR="${{ steps.where.outputs.dir }}"
          OUTPUT_DIR="$PROJECT_DIR/target/docs"
          mkdir -p "$OUTPUT_DIR"
          
          # Copy template files to output directory
          mkdir -p "$OUTPUT_DIR/templates"
          cp "$PROJECT_DIR/docs/templates/enterprise-docs.css" "$OUTPUT_DIR/templates/" || true
          cp "$PROJECT_DIR/docs/templates/enterprise-docs.html" "$OUTPUT_DIR/templates/" || true
          echo "‚úì Copied template files to output directory"
          
          # Verify OpenAPI YAML exists
          if [ ! -f "$PROJECT_DIR/docs/api/openapi.yaml" ]; then
            echo "‚ùå OpenAPI YAML not found at $PROJECT_DIR/docs/api/openapi.yaml"
            exit 1
          fi
          
          echo "‚úì Found OpenAPI spec at $PROJECT_DIR/docs/api/openapi.yaml"
          echo "  File size: $(wc -c < $PROJECT_DIR/docs/api/openapi.yaml) bytes"
          
          # Generate ReDoc HTML from modular YAML (with external path references)
          # Output to api-docs.html instead of index.html to avoid overwriting landing page
          redocly build-docs "$PROJECT_DIR/docs/api/openapi.yaml" -o "$OUTPUT_DIR/api-docs.html"
          echo "‚úì ReDoc HTML generated at $OUTPUT_DIR/api-docs.html"
          echo "  Output size: $(wc -c < $OUTPUT_DIR/api-docs.html) bytes"

      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Generate HTML from Architecture Markdown with Enterprise Template
        run: |
          PROJECT_DIR="${{ steps.where.outputs.dir }}"
          ARCH_DIR="$PROJECT_DIR/docs/architecture"
          OUTPUT_DIR="$PROJECT_DIR/target/docs/architecture"
          TEMPLATE="$PROJECT_DIR/docs/templates/enterprise-docs.html"
          
          mkdir -p "$OUTPUT_DIR"
          
          if [ ! -f "$TEMPLATE" ]; then
            echo "‚ùå Enterprise template not found at $TEMPLATE"
            exit 1
          fi
          
          # ===================================================================
          # PANDOC LUA FILTER: markdown links & mermaid diagram rendering
          # ===================================================================
          # This filter performs two critical transformations:
          #
          # 1. MARKDOWN LINK CONVERSION
          #    - Input: [link](file.md) or [link](file.md#section)
          #    - Output: [link](file.html) or [link](file.html#section)
          #    - Purpose: Pandoc preserves .md extensions; filter converts to .html
          #
          # 2. MERMAID DIAGRAM RENDERING (CRITICAL FIX)
          #    - Input: ```mermaid ...diagram... ``` (code fence)
          #    - Output: <div class="mermaid">...diagram...</div>
          #    - Problem Solved: Pandoc default wraps in <code>, breaking mermaid.js
          #    - Solution: Output raw HTML div that mermaid.js can find and render
          #
          # Processing Pipeline:
          #    markdown ‚Üí Pandoc AST ‚Üí Lua filter ‚Üí HTML (with divs) ‚Üí mermaid.js renders
          #
          # ===================================================================
          
          cat > /tmp/md-to-html-links.lua << 'EOF'
          function Link(el)
            -- Convert .md links to .html
            if el.target:match("%.md$") then
              el.target = el.target:gsub("%.md$", ".html")
            elseif el.target:match("%.md#") then
              el.target = el.target:gsub("%.md#", ".html#")
            end
            return el
          end
          
          -- Handle mermaid code blocks specially - output as raw HTML div
          function CodeBlock(el)
            if el.classes:includes('mermaid') then
              -- Output mermaid code as a div with class="mermaid" containing the code
              local content = el.text
              local html = '<div class="mermaid">' .. content .. '</div>'
              return pandoc.RawBlock('html', html)
            end
            return el
          end
          EOF
          
          # Find all markdown files in architecture directory
          find "$ARCH_DIR" -type f -name "*.md" | while read md_file; do
            # Calculate relative path from architecture base
            rel_path="${md_file#$ARCH_DIR/}"
            out_file="$OUTPUT_DIR/${rel_path%.md}.html"
            
            # Create output directory structure
            mkdir -p "$(dirname "$out_file")"
            
            # Convert markdown to HTML with template
            pandoc "$md_file" \
              --from markdown \
              --to html \
              --template "$TEMPLATE" \
              --lua-filter /tmp/md-to-html-links.lua \
              --toc \
              --toc-depth=3 \
              --standalone \
              -o "$out_file"
            
            echo "‚úì Generated: $out_file"
          done
          
          echo "‚úì All architecture markdown files converted to HTML"

      - name: Convert Additional Markdown to HTML (preserve structure)
        run: |
          BASE="${{ steps.where.outputs.dir }}/docs"
          OUT="${{ steps.where.outputs.dir }}/target/docs/generated"
          TEMPLATE="${{ steps.where.outputs.dir }}/docs/templates/enterprise-docs.html"
          mkdir -p "$OUT"
          
          # Skip architecture directory (already processed) and templates
          if [ -d "$BASE" ]; then
            find "$BASE" -type f -name "*.md" \
              ! -path "*/architecture/*" \
              ! -path "*/templates/*" | while read md; do
              rel="${md#$BASE/}"
              out_file="$OUT/${rel%.md}.html"
              mkdir -p "$(dirname "$out_file")"
              
              if [ -f "$TEMPLATE" ]; then
                pandoc "$md" \
                  --from markdown \
                  --to html \
                  --template "$TEMPLATE" \
                  --toc \
                  --standalone \
                  -o "$out_file"
              else
                pandoc "$md" \
                  --from markdown \
                  --to html \
                  --toc \
                  -s \
                  -o "$out_file"
              fi
            done
          fi

      - name: Fix Directory Links in Generated HTML
        run: |
          OUTPUT_DIR="${{ steps.where.outputs.dir }}/target/docs"
          
          # Find all generated HTML files and fix directory links
          find "$OUTPUT_DIR" -type f -name "*.html" | while read html_file; do
            # Fix links like href="path/to/directory/" to href="path/to/directory/index.html"
            sed -i 's|href="\([^"]*\)/"|href="\1/index.html"|g' "$html_file"
            sed -i "s|href='\([^']*\)/'|href='\1/index.html'|g" "$html_file"
            echo "‚úì Fixed directory links in: $(basename $html_file)"
          done
          
          echo "‚úì All directory links fixed in generated HTML files"

      - name: Create Navigation Index
        run: |
          PROJECT_DIR="${{ steps.where.outputs.dir }}"
          OUTPUT_DIR="$PROJECT_DIR/target/docs"
          
          # Create main index.html that redirects or shows overview
          cat > "$OUTPUT_DIR/index.html" << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>StockEase Documentation</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
                  .hero {
                      background: linear-gradient(135deg, #0066cc 0%, #004a99 100%);
                      color: white;
                      padding: 4rem 1.5rem;
                      text-align: center;
                  }
                  .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; }
                  .hero p { font-size: 1.1rem; margin-bottom: 2rem; opacity: 0.9; }
                  .container { max-width: 1000px; margin: 0 auto; }
                  .docs-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                      gap: 2rem;
                      padding: 3rem 1.5rem;
                  }
                  .doc-card {
                      background: white;
                      padding: 1.5rem;
                      border-radius: 8px;
                      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                      transition: transform 0.2s, box-shadow 0.2s;
                      text-decoration: none;
                      color: inherit;
                      border-top: 3px solid #0066cc;
                  }
                  .doc-card:hover {
                      transform: translateY(-4px);
                      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                  }
                  .doc-card h3 { font-size: 1.25rem; margin-bottom: 0.5rem; color: #0066cc; }
                  .doc-card p { color: #666; font-size: 0.95rem; }
                  footer {
                      background: #f8f9fa;
                      padding: 2rem;
                      text-align: center;
                      color: #666;
                      font-size: 0.9rem;
                  }
              </style>
          </head>
          <body>
              <div class="hero">
                  <div class="container">
                      <h1>üìö StockEase Documentation</h1>
                      <p>Complete API and Architecture Reference</p>
                  </div>
              </div>
              <div class="container">
                  <div class="docs-grid">
                      <a href="api-docs.html" class="doc-card">
                          <h3>üîå API Documentation</h3>
                          <p>Interactive API specification with all endpoints, request/response schemas, and security details.</p>
                      </a>
                      <a href="architecture/overview.html" class="doc-card">
                          <h3>üèóÔ∏è Architecture Overview</h3>
                          <p>System design, layers, components, and technology stack overview.</p>
                      </a>
                      <a href="architecture/backend.html" class="doc-card">
                          <h3>‚öôÔ∏è Backend Architecture</h3>
                          <p>Spring Boot application structure, controllers, services, and data layers.</p>
                      </a>
                      <a href="architecture/frontend.html" class="doc-card">
                          <h3>üé® Frontend Architecture</h3>
                          <p>React/TypeScript application structure, components, and state management.</p>
                      </a>
                      <a href="architecture/security.html" class="doc-card">
                          <h3>üîê Security Architecture</h3>
                          <p>Authentication, authorization, JWT, role-based access control, and data protection.</p>
                      </a>
                      <a href="architecture/deployment.html" class="doc-card">
                          <h3>üöÄ Deployment Strategy</h3>
                          <p>Docker containerization, CI/CD pipelines, and cloud deployment patterns.</p>
                      </a>
                      <a href="architecture/testing-architecture.html" class="doc-card">
                          <h3>‚úÖ Testing Architecture</h3>
                          <p>Test pyramid, strategies, unit tests, integration tests, and security testing.</p>
                      </a>
                      <a href="architecture/decisions/index.html" class="doc-card">
                          <h3>üìã Design Decisions</h3>
                          <p>Record of Architectural Decision Records (ADRs) and technical justifications.</p>
                      </a>
                  </div>
              </div>
              <footer>
                  <p><strong>StockEase</strong> - Inventory Management System</p>
                  <p>Enterprise-Grade API & Architecture Documentation</p>
              </footer>
          </body>
          </html>
          EOF
          
          echo "‚úì Created documentation index"

      - name: Verify Generated Documentation
        run: |
          OUTPUT_DIR="${{ steps.where.outputs.dir }}/target/docs"
          echo "üìä Generated Documentation Files:"
          find "$OUTPUT_DIR" -type f \( -name "*.html" -o -name "*.json" \) | wc -l
          echo ""
          echo "üìÅ Directory structure:"
          du -sh "$OUTPUT_DIR" 2>/dev/null || echo "(directory size)"
          echo ""
          echo "‚úì Documentation generation complete"

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ steps.where.outputs.dir }}/target/docs
          # cname: your.domain  # optional
