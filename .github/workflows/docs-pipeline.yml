name: Docs Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'pom.xml'
      - 'src/main/**'
      - 'backend/pom.xml'
      - 'backend/src/main/**'
      - 'backend/docs/**'
      - '.github/workflows/docs-pipeline.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Detect project root (root vs /backend)
        id: where
        run: |
          if [ -f "docs/api/openapi.yaml" ] && [ -f "pom.xml" ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          elif [ -f "backend/docs/api/openapi.yaml" ] && [ -f "backend/pom.xml" ]; then
            echo "dir=backend" >> $GITHUB_OUTPUT
          else
            echo "❌ No OpenAPI YAML found in docs/api/ or backend/docs/api/" >&2
            exit 1
          fi
          echo "Using dir=$(cat $GITHUB_OUTPUT | cut -d= -f2)"

      - name: Install Node.js and ReDoc CLI
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate documentation from modular OpenAPI YAML
        run: |
          npm install -g @redocly/cli
          PROJECT_DIR="${{ steps.where.outputs.dir }}"
          OUTPUT_DIR="$PROJECT_DIR/target/docs"
          mkdir -p "$OUTPUT_DIR"
          
          # Verify OpenAPI YAML exists
          if [ ! -f "$PROJECT_DIR/docs/api/openapi.yaml" ]; then
            echo "❌ OpenAPI YAML not found at $PROJECT_DIR/docs/api/openapi.yaml"
            exit 1
          fi
          
          echo "✓ Found OpenAPI spec at $PROJECT_DIR/docs/api/openapi.yaml"
          echo "  File size: $(wc -c < $PROJECT_DIR/docs/api/openapi.yaml) bytes"
          
          # Generate ReDoc HTML from modular YAML (with external path references)
          redocly build-docs "$PROJECT_DIR/docs/api/openapi.yaml" -o "$OUTPUT_DIR/index.html"
          echo "✓ ReDoc HTML generated at $OUTPUT_DIR/index.html"
          echo "  Output size: $(wc -c < $OUTPUT_DIR/index.html) bytes"

      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Convert Markdown to HTML (preserve structure)
        run: |
          BASE="${{ steps.where.outputs.dir }}/docs"
          OUT="${{ steps.where.outputs.dir }}/target/docs/generated"
          mkdir -p "$OUT"
          if [ -d "$BASE" ]; then
            find "$BASE" -type f -name "*.md" | while read md; do
              rel="${md#$BASE/}"
              out_file="$OUT/${rel%.md}.html"
              mkdir -p "$(dirname "$out_file")"
              pandoc "$md" -f markdown -t html --toc -s -o "$out_file"
            done
          else
            echo "No docs directory at $BASE (skipping Markdown conversion)."
          fi

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ steps.where.outputs.dir }}/target/docs
          # cname: your.domain  # optional
