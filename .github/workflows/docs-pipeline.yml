name: Docs Pipeline

on:
  push:
    branches: [ main ]
    paths:
      - 'pom.xml'
      - 'src/main/**'
      - 'backend/pom.xml'
      - 'backend/src/main/**'
      - 'backend/docs/**'
      - '.github/workflows/docs-pipeline.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Detect project root (root vs /backend)
        id: where
        run: |
          if [ -f "mvnw" ] && [ -f "pom.xml" ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          elif [ -f "backend/mvnw" ] && [ -f "backend/pom.xml" ]; then
            echo "dir=backend" >> $GITHUB_OUTPUT
          else
            echo "❌ No mvnw/pom.xml in repo root or /backend" >&2
            exit 1
          fi
          echo "Using dir=$(cat $GITHUB_OUTPUT | cut -d= -f2)"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build & generate OpenAPI (manual java -jar + curl)
        working-directory: ${{ steps.where.outputs.dir }}
        run: |
          chmod +x ./mvnw
          ./mvnw -B -ntp -DskipTests clean package
          mkdir -p target/docs
          # Start app in background with docs profile
          java -Dspring.profiles.active=docs -jar target/stockease-0.0.1-SNAPSHOT.jar > /tmp/app.log 2>&1 &
          APP_PID=$!
          echo "App started with PID $APP_PID"
          # Wait for app to initialize
          sleep 25
          # Check if app is still running
          if ! kill -0 $APP_PID 2>/dev/null; then
            echo "❌ App crashed. Logs:"
            cat /tmp/app.log
            exit 1
          fi
          # Fetch OpenAPI spec (curl output goes to file, verbose to stderr)
          echo "Fetching http://localhost:8080/v3/api-docs"
          curl -s http://localhost:8080/v3/api-docs > target/docs/openapi.json
          # Verify it was created and has content
          if [ ! -f target/docs/openapi.json ] || [ ! -s target/docs/openapi.json ]; then
            echo "❌ openapi.json is empty or missing. App logs:"
            cat /tmp/app.log
            exit 1
          fi
          echo "✓ OpenAPI spec generated ($(wc -c < target/docs/openapi.json) bytes)"
          # Kill app
          kill $APP_PID 2>/dev/null || true

      - name: Generate ReDoc HTML
        run: |
          npm install -g redoc-cli
          cd "${{ steps.where.outputs.dir }}/target/docs"
          # Verify openapi.json exists and is valid JSON
          if [ ! -f openapi.json ]; then
            echo "❌ openapi.json not found"
            exit 1
          fi
          echo "OpenAPI spec size: $(wc -c < openapi.json) bytes"
          # Show first 100 chars to verify it's valid JSON
          echo "First 100 chars:"
          head -c 100 openapi.json
          echo ""
          # Build ReDoc
          redoc-cli build openapi.json -o index.html
          echo "✓ ReDoc HTML generated"

      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Convert Markdown to HTML (preserve structure)
        run: |
          BASE="${{ steps.where.outputs.dir }}/docs"
          OUT="${{ steps.where.outputs.dir }}/target/docs/generated"
          mkdir -p "$OUT"
          if [ -d "$BASE" ]; then
            find "$BASE" -type f -name "*.md" | while read md; do
              rel="${md#$BASE/}"
              out_file="$OUT/${rel%.md}.html"
              mkdir -p "$(dirname "$out_file")"
              pandoc "$md" -f markdown -t html --toc -s -o "$out_file"
            done
          else
            echo "No docs directory at $BASE (skipping Markdown conversion)."
          fi

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ steps.where.outputs.dir }}/target/docs
          # cname: your.domain  # optional
