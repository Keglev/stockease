name: Docs Coverage Deploy

on:
  workflow_run:
    workflows: ["Docs Pipeline"]
    types: [completed]

permissions:
  contents: write

jobs:
  coverage-deploy:
    # Only run if Docs Pipeline succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download docs-site artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-site
          path: target/docs
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Detect project root
        id: where
        run: |
          if [ -f "pom.xml" ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          elif [ -f "backend/pom.xml" ]; then
            echo "dir=backend" >> $GITHUB_OUTPUT
          else
            echo "dir=." >> $GITHUB_OUTPUT
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Run Maven tests with JaCoCo
        run: |
          PROJECT_DIR="${{ steps.where.outputs.dir }}"
          echo "Running tests in $PROJECT_DIR"
          cd "$PROJECT_DIR"
          mvn -B clean test
          echo "Tests completed - coverage generated at $PROJECT_DIR/docs/coverage"

      - name: Verify artifact was downloaded
        run: |
          echo "Contents of target/docs:"
          ls -laR target/docs 2>/dev/null | head -50 || echo "target/docs not found or empty"

      - name: Generate coverage wrapper and merge into site
        run: |
          PROJECT_DIR="${{ steps.where.outputs.dir }}"
          OUTPUT_DIR="target/docs"
          COVERAGE_SRC="$PROJECT_DIR/docs/coverage"
          COVERAGE_OUT="$OUTPUT_DIR/coverage"

          echo "Merging coverage:"
          echo "  SOURCE: $COVERAGE_SRC"
          echo "  OUTPUT: $COVERAGE_OUT"

          mkdir -p "$COVERAGE_OUT"

          # Verify docs were downloaded
          if [ ! -f "$OUTPUT_DIR/index.html" ]; then
            echo "⚠️  WARNING: Docs artifact may not have downloaded properly"
            echo "Contents of target/docs:"
            ls -laR target/docs 2>/dev/null | head -20 || true
          fi

          # Create coverage wrapper index.html using printf to avoid YAML parsing issues
          printf '%s\n' \
            '<!DOCTYPE html>' \
            '<html lang="en">' \
            '<head>' \
            '    <meta charset="UTF-8">' \
            '    <meta name="viewport" content="width=device-width, initial-scale=1.0">' \
            '    <title>StockEase - Code Coverage Report</title>' \
            '    <link rel="stylesheet" href="/stockease/templates/enterprise-docs.css">' \
            '    <style>' \
            '        .coverage-iframe { width: 100%; height: 80vh; border: 1px solid #ddd; border-radius: 4px; }' \
            '        .coverage-container { padding: 1.5rem; background: #fff; border-radius: 6px; }' \
            '    </style>' \
            '</head>' \
            '<body>' \
            '  <div class="container">' \
            '    <main>' \
            '      <div class="content">' \
            '        <h1>Code Coverage Report</h1>' \
            '        <p>JaCoCo coverage for the StockEase backend. For full details see the embedded report below.</p>' \
            '        <p><a href="raw/index.html">Open raw JaCoCo report</a></p>' \
            '        <iframe src="raw/index.html" class="coverage-iframe" title="JaCoCo Coverage Report"></iframe>' \
            '      </div>' \
            '    </main>' \
            '  </div>' \
            '</body>' \
            '</html>' > "$COVERAGE_OUT/index.html"

          if [ -d "$COVERAGE_SRC" ]; then
            echo "✓ Copying JaCoCo coverage files"
            cp -r "$COVERAGE_SRC"/* "$COVERAGE_OUT/" 2>&1 | head -10
            
            # Create raw subdirectory with detailed reports
            mkdir -p "$COVERAGE_OUT/raw"
            for f in $(ls "$COVERAGE_SRC" 2>/dev/null | grep -v "^index.html$" || true); do
              [ -e "$COVERAGE_SRC/$f" ] && cp -r "$COVERAGE_SRC/$f" "$COVERAGE_OUT/raw/" 2>/dev/null || true
            done
            echo "✓ Coverage merged into target/docs/coverage"
          else
            echo "⚠️  No coverage generated at $COVERAGE_SRC"
          fi

          echo "Final structure of target/docs:"
          find target/docs -type f -name "*.html" | head -20

      - name: Deploy docs with coverage to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: target/docs
