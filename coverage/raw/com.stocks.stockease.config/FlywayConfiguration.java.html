<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FlywayConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">StockEase</a> &gt; <a href="index.source.html" class="el_package">com.stocks.stockease.config</a> &gt; <span class="el_source">FlywayConfiguration.java</span></div><h1>FlywayConfiguration.java</h1><pre class="source lang-java linenums">package com.stocks.stockease.config;

import javax.sql.DataSource;

import org.flywaydb.core.Flyway;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;

/**
 * Database migration configuration using Flyway.
 * 
 * Problem solved:
 * - Spring Boot 3.5.x with Spring Data JPA causes circular dependency:
 *   EntityManagerFactory wants to validate schema, but migrations haven't run yet
 * - Solution: Manually execute migrations via initMethod before JPA initialization
 * 
 * Migration discovery:
 * - Location: classpath:db/migration/
 * - Naming: V{VERSION}__{DESCRIPTION}.sql (e.g., V1__init_schema.sql)
 * - Execution: Sorted by version number, executed once per database
 * 
 * Features configured:
 * - baselineOnMigrate: Creates baseline if flyway_schema_history table doesn't exist
 * - cleanDisabled: Prevents accidental database wipe (safety for production)
 * - outOfOrder: Allows applying migrations older than current baseline (recovery scenarios)
 * - connectRetries: Retry failed connections (handles slow database startup)
 * 
 * Initialization sequence:
 * 1. Spring creates FlywayConfiguration bean
 * 2. flyway() method invoked (creates Flyway instance)
 * 3. initMethod=&quot;migrate&quot; runs immediately (before @RestController beans)
 * 4. Migrations execute in order (V1__, V2__, etc.)
 * 5. EntityManagerFactory initializes with migrated schema
 * 6. Application ready for requests
 * 
 * @author Team StockEase
 * @version 1.0
 * @since 2025-01-01
 */
@Configuration
@ConditionalOnClass(Flyway.class)
<span class="fc" id="L45">public class FlywayConfiguration {</span>

    /**
     * Property to enable/disable Flyway migrations.
     * Default: true (enabled)
     * Override: spring.flyway.enabled=false (disable in test profile)
     */
    @Value(&quot;${spring.flyway.enabled:true}&quot;)
    private boolean flywayEnabled;

    /**
     * Creates and executes Flyway migrations immediately during startup.
     * 
     * Why @Primary and initMethod=&quot;migrate&quot;:
     * - Prevents Spring Data JPA from initializing EntityManagerFactory before migrations run
     * - Executes migrations in constructor (implicit dependency)
     * - Alternative approaches (like @DependsOn) don't guarantee migration order in Spring 3.5.x
     * 
     * Configuration details:
     * - locations: Source migrations from classpath:db/migration/ (V*__*.sql files)
     * - baselineOnMigrate: Create baseline if first migration run (idempotent)
     * - cleanDisabled: Prevent accidental truncate/drop (safety net for production)
     * - outOfOrder: Allow non-sequential migrations (handle backfill scenarios)
     * - connectRetries: Retry 20 times with 2-second intervals (handles serverless DB cold-start)
     * 
     * Flyway profiles:
     * - dev: In-memory H2 database (migrations ephemeral)
     * - test: TestConfig creates separate test database
     * - prod: PostgreSQL (migrations persisted)
     * 
     * @param dataSource Spring-managed DataSource (auto-wired from application.properties)
     * @return Configured Flyway instance (migrations already executed by initMethod)
     * @throws Exception if DataSource connection fails after retries
     */
    @Primary
    @Bean(initMethod = &quot;migrate&quot;)
    public Flyway flyway(DataSource dataSource) throws Exception {
        
        // Honor explicit disable flag (useful for test profiles)
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">        if (!flywayEnabled) {</span>
<span class="nc" id="L85">            return Flyway.configure().dataSource(dataSource).load();</span>
        }

        // Configure Flyway with resilience and safety settings
<span class="fc" id="L89">        Flyway flyway = Flyway.configure()</span>
<span class="fc" id="L90">                .dataSource(dataSource)</span>
<span class="fc" id="L91">                .locations(&quot;classpath:db/migration&quot;) // Location of V*__*.sql files</span>
<span class="fc" id="L92">                .baselineOnMigrate(true) // Create baseline if schema_history doesn't exist</span>
<span class="fc" id="L93">                .cleanDisabled(true) // Prevent accidental database wipe</span>
<span class="fc" id="L94">                .outOfOrder(true) // Allow non-sequential migrations</span>
<span class="fc" id="L95">                .connectRetries(20) // Retry 20 times (handles slow DB startup)</span>
<span class="fc" id="L96">                .connectRetriesInterval(2) // 2 seconds between retries</span>
<span class="fc" id="L97">                .load();</span>

        // Execute migrations immediately (before other beans initialize)
        // This ensures schema is ready before JPA EntityManagerFactory needs it
<span class="fc" id="L101">        flyway.migrate();</span>
<span class="fc" id="L102">        return flyway;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>