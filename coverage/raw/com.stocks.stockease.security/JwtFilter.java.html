<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">StockEase</a> &gt; <a href="index.source.html" class="el_package">com.stocks.stockease.security</a> &gt; <span class="el_source">JwtFilter.java</span></div><h1>JwtFilter.java</h1><pre class="source lang-java linenums">package com.stocks.stockease.security;

import org.springframework.lang.NonNull;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

/**
 * JWT token extraction and validation filter.
 * 
 * Spring Security filter that runs once per request. Extracts JWT token from
 * Authorization header, validates signature/expiration, loads user details,
 * and populates SecurityContext for authorization checks on protected endpoints.
 * 
 * Filter chain position: Early in chain (before controller execution).
 * Bypass: Public endpoints (login, health checks) via SecurityConfig.
 * Disabled in 'docs' profile for CI/CD documentation generation.
 * 
 * @author Team StockEase
 * @version 1.0
 * @since 2025-01-01
 */
@Component
@org.springframework.context.annotation.Profile(&quot;!docs&quot;)
public class JwtFilter extends OncePerRequestFilter {

    /**
     * JWT utility for token validation and claims extraction.
     */
    private final JwtUtil jwtUtil;

    /**
     * Spring Security UserDetailsService for loading user authorities.
     * Implementation: CustomUserDetailsService (loads from UserRepository).
     */
    private final UserDetailsService userDetailsService;

    /**
     * Constructs filter with dependencies.
     * 
     * @param jwtUtil JWT operations utility
     * @param userDetailsService loads user details for authentication
     */
<span class="fc" id="L46">    public JwtFilter(JwtUtil jwtUtil, UserDetailsService userDetailsService) {</span>
<span class="fc" id="L47">        this.jwtUtil = jwtUtil;</span>
<span class="fc" id="L48">        this.userDetailsService = userDetailsService;</span>
<span class="fc" id="L49">    }</span>

    /**
     * Processes request to validate JWT and populate security context.
     * 
     * Flow:
     * 1. Extract &quot;Authorization: Bearer &lt;token&gt;&quot; header
     * 2. Validate token signature and expiration
     * 3. Extract username and role from token claims
     * 4. Load user details (authorities/roles) from database
     * 5. Create UsernamePasswordAuthenticationToken
     * 6. Store in SecurityContext for downstream @PreAuthorize checks
     * 7. Continue filter chain
     * 
     * If no token or validation fails, request continues without authentication
     * (handled by explicit @PreAuthorize or global security config).
     * 
     * @param request HTTP request with optional Authorization header
     * @param response HTTP response
     * @param filterChain next filter in chain
     * @throws java.io.IOException if I/O error
     * @throws jakarta.servlet.ServletException if servlet error
     */
    @Override
    protected void doFilterInternal(
        @NonNull jakarta.servlet.http.HttpServletRequest request,
        @NonNull jakarta.servlet.http.HttpServletResponse response,
        @NonNull jakarta.servlet.FilterChain filterChain
    ) throws java.io.IOException, jakarta.servlet.ServletException {

        // Extract Authorization header (format: &quot;Bearer &lt;token&gt;&quot;)
<span class="fc" id="L80">        String authHeader = request.getHeader(&quot;Authorization&quot;);</span>

<span class="pc bpc" id="L82" title="3 of 4 branches missed.">        if (authHeader != null &amp;&amp; authHeader.startsWith(&quot;Bearer &quot;)) {</span>
            // Extract token by removing &quot;Bearer &quot; prefix (7 characters)
<span class="nc" id="L84">            String token = authHeader.substring(7);</span>

            // Validate token: signature verification and expiration check
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (jwtUtil.validateToken(token)) {</span>
                // Extract username from JWT &quot;sub&quot; claim
<span class="nc" id="L89">                String username = jwtUtil.extractUsername(token);</span>

                // Extract role from JWT custom &quot;role&quot; claim
<span class="nc" id="L92">                String role = jwtUtil.extractRole(token);</span>
                // DEBUG: Log extracted role for troubleshooting (remove in production for performance)
<span class="nc" id="L94">                System.out.println(&quot;Token role: &quot; + role);</span>

                // Load user details from database (including authorities for @PreAuthorize)
                // CustomUserDetailsService maps role to Spring Security authorities (ROLE_ADMIN, ROLE_USER)
<span class="nc" id="L98">                var userDetails = userDetailsService.loadUserByUsername(username);</span>

                // Create authentication token with user details and authorities
                // No credentials in token (already authenticated by JWT signature)
<span class="nc" id="L102">                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(</span>
<span class="nc" id="L103">                        userDetails, null, userDetails.getAuthorities());</span>

                // Store authentication in SecurityContext (available to @PreAuthorize, etc.)
<span class="nc" id="L106">                SecurityContextHolder.getContext().setAuthentication(authToken);</span>
            }
        }
        // Continue filter chain regardless of authentication success
        // Unauthenticated requests will be rejected by @PreAuthorize on protected endpoints
<span class="fc" id="L111">        filterChain.doFilter(request, response);</span>
<span class="fc" id="L112">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>